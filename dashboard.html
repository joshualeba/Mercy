{% extends "templates/base.html" %}

{% block title %}Mercy dashboard{% endblock %}

{% block extra_css %}
<link href="css/dashboard.css" rel="stylesheet">
<link href="css/simulador_comun.css" rel="stylesheet">
{% endblock %}

{% block navbar_left %}
<button class="btn btn-glass d-lg-none me-2" id="sidebarToggle" aria-label="Toggle navigation">
    <i class="bi bi-list"></i>
</button>
<a class="navbar-brand d-flex align-items-center" href="#" data-section="inicio">
    <img src="https://res.cloudinary.com/dpvm2gro2/image/upload/v1769711039/logo_qp8c8w.png" alt="Logo Mercy"
        class="me-2" width="40" height="40">
</a>
{% endblock %}

{% block user_dropdown_content %}
<button class="btn btn-outline-primary btn-sm" data-section="perfil" id="miPerfilBtn">
    <i class="bi bi-person me-2"></i>Mi perfil
</button>
{% endblock %}

{% block content %}
<!-- Sección: Sidebar lateral -->
<div class="sidebar glass-sidebar" id="sidebar">
    <div class="sidebar-content">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="inicio">
                    <i class="bi bi-house-door"></i>
                    <span>Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="simulaciones">
                    <i class="bi bi-calculator"></i>
                    <span>Simulaciones</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="test-conocimientos">
                    <i class="bi bi-journal-check"></i>
                    <span>Test de conocimientos</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/sofipos">
                    <i class="bi bi-graph-up"></i>
                    <span>Ranking SOFIPOs</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="glosario">
                    <i class="bi bi-book"></i>
                    <span>Glosario de términos y consejos de gestión</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="perfil">
                    <i class="bi bi-person"></i>
                    <span>Mi perfil</span>
                </a>
            </li>
        </ul>
    </div>

    <div class="sidebar-footer">
        <button class="btn btn-outline-danger w-100" id="logoutBtn">
            <i class="bi bi-box-arrow-right me-2"></i>
            Cerrar sesión
        </button>
    </div>
</div>

<!-- Sección: Contenido principal -->
<main class="main-content">
    <!-- Sección: Inicio (Diseño Limpio y Profesional) -->
    <section id="inicio-section" class="content-section">
        <div class="fade-in">
            <!-- Hero de Bienvenida Premium v3 -->
            <div class="glass-card has-bubbles p-4 p-md-5 mb-5 border-0 shadow-lg position-relative overflow-hidden"
                style="border-radius: 24px;">
                <!-- Fondo animado interactivo -->
                <div class="position-absolute top-0 end-0 h-100 w-100 opacity-25"
                    style="background: radial-gradient(circle at right 20%, rgba(13, 110, 253, 0.4), transparent 50%), radial-gradient(circle at left 80%, rgba(13, 202, 240, 0.2), transparent 50%); mix-blend-mode: multiply;">
                </div>

                <div class="row align-items-center position-relative z-1">
                    <div class="col-lg-7 text-center text-lg-start mb-4 mb-lg-0">
                        <h1 class="display-5 fw-bold mb-3" style="letter-spacing: -0.03em;">
                            Bienvenido al futuro de tus finanzas, <span class="text-primary">{{ session.get('nombres',
                                'Usuario').split(' ')[0] }}</span>.
                        </h1>
                        <p class="lead text-muted mb-4 opacity-75" style="max-width: 550px;">
                            Simuladores, herramientas, ranking de SOFIPOs e inteligencia artificial: todo en un solo
                            lugar para que tu dinero trabaje por ti.
                        </p>
                        <div class="d-flex flex-wrap gap-3 justify-content-center justify-content-lg-start">
                            <a href="#" data-section="simulaciones"
                                class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm hover-scale d-flex align-items-center">
                                <i class="bi bi-rocket-takeoff me-2"></i> Explorar simuladores
                            </a>
                        </div>
                    </div>

                    <div class="col-lg-5 position-relative">
                        <div class="d-flex flex-column gap-3">
                            <!-- Novedad Groq API Box -->
                            <div class="glass-card has-bubbles shadow-sm border border-primary border-opacity-25 p-4 text-start hover-scale position-relative overflow-hidden"
                                style="border-radius: 20px; background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(13, 110, 253, 0.05)); z-index: 5;">
                                <div class="position-absolute top-0 end-0 mt-3 me-3">
                                    <span class="spinner-grow spinner-grow-sm text-primary" role="status"
                                        id="mercyRadarSpinner"></span>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary text-white rounded-circle p-2 me-3 d-flex align-items-center justify-content-center shadow"
                                        style="width: 40px; height: 40px;">
                                        <i class="bi bi-lightning-charge-fill fs-5"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bolder mb-0 text-dark" style="letter-spacing: -0.02em;">Mercy
                                            radar</h6>
                                        <small class="text-primary fw-semibold">Inteligencia en tiempo real</small>
                                    </div>
                                </div>
                                <p class="small text-muted mb-0 fw-medium lh-base" id="mercyNewsContainer"
                                    style="font-size: 0.9rem;">
                                    Analizando y extrayendo los últimos movimientos de los mercados financieros...
                                </p>
                            </div>

                            <!-- Widget Interactivo de Crecimiento -->
                            <div class="glass-card has-bubbles shadow-lg border-0 p-4 text-start position-relative"
                                style="border-radius: 20px; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); z-index: 5;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0"><i
                                            class="bi bi-graph-up-arrow text-success me-2"></i>Crecimiento rápido</h6>
                                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2">10% a 5
                                        años</span>
                                </div>
                                <p class="small text-muted mb-3">Juega con la barra para ver cuánto tendrías invirtiendo
                                    en
                                    una buena SOFIPO mes a mes.</p>

                                <div class="d-flex justify-content-between mb-1">
                                    <label class="small fw-bold text-dark">Ahorro mensual:</label>
                                    <span id="quickSimulValue" class="small fw-bold text-primary">$2,000</span>
                                </div>
                                <input type="range" class="form-range mb-4" id="quickSimulRange" min="500" max="10000"
                                    step="500" value="2000">

                                <div class="p-3 bg-white bg-opacity-75 rounded-3 border d-flex flex-column mb-0">
                                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                                        <small class="text-muted fw-semibold">Tú habrás aportado (en 5 años):</small>
                                        <small class="fw-bold text-dark" id="quickSimulInvested">$120,000</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted d-block fw-semibold"
                                                style="font-size: 0.75rem;">Total final (capital + ganancias):</small>
                                            <h4 class="fw-bold text-success mb-0 letter-spacing-tight"
                                                id="quickSimulResult">$154,874</h4>
                                        </div>
                                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                                            style="width: 45px; height: 45px; flex-shrink: 0; margin-left: 10px;">
                                            <i class="bi bi-currency-dollar fs-5"></i>
                                        </div>
                                    </div>
                                </div>

                                <script>
                                    // Script for quick simulation + news API fetch
                                    document.addEventListener('DOMContentLoaded', function () {
                                        // Simulator
                                        const slider = document.getElementById('quickSimulRange');
                                        const valueDisplay = document.getElementById('quickSimulValue');
                                        const resultDisplay = document.getElementById('quickSimulResult');
                                        const investedDisplay = document.getElementById('quickSimulInvested');

                                        function updateQuickSim() {
                                            const value = parseInt(slider.value);
                                            // Se agrega la ',' de miles
                                            valueDisplay.innerText = '$' + value.toLocaleString('en-US');

                                            const r = 0.10 / 12; // Modificado a 10% anual para ser más realista
                                            const n = 5 * 12; // 5 años
                                            const PMT = value;
                                            const FV = PMT * ((Math.pow(1 + r, n) - 1) / r);
                                            const totalInvested = PMT * n;

                                            if (investedDisplay) {
                                                investedDisplay.innerText = '$' + totalInvested.toLocaleString('en-US');
                                            }

                                            // Si hay centavos, poner 2 decimales, y con , de miles
                                            resultDisplay.innerText = '$' + FV.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                        }

                                        if (slider) {
                                            slider.addEventListener('input', updateQuickSim);
                                            updateQuickSim();
                                        }

                                        // Fetch Financial News
                                        const newsContainer = document.getElementById('mercyNewsContainer');
                                        const spinner = document.getElementById('mercyRadarSpinner');
                                        if (newsContainer) {
                                            // Agregar date.now() para que nunca se cachee e invoque siempre uno nuevo al recargar
                                            fetch('/api/noticia_financiera?t=' + Date.now())
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (spinner) spinner.style.display = 'none';
                                                    if (data.success && data.respuesta) {
                                                        newsContainer.innerHTML = `<span class="fw-bold text-dark">Radar:</span> ${data.respuesta}`;
                                                    } else {
                                                        newsContainer.innerHTML = "Mantente siempre informado sobre las tasas de rendimiento para que tu dinero crezca.";
                                                    }
                                                })
                                                .catch(err => {
                                                    if (spinner) spinner.style.display = 'none';
                                                    newsContainer.innerHTML = "Revisa tus finanzas cada semana para mantenerte seguro.";
                                                });
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Redesigned Herramientas Section -->
            <div class="mb-5">
                <div class="d-flex align-items-center mb-4">
                    <h4 class="fw-bold mb-0 me-3">Herramientas Mercy</h4>
                    <div class="flex-grow-1 border-bottom" style="opacity: 0.15;"></div>
                </div>

                <div class="row g-4">
                    <!-- Simuladores -->
                    <div class="col-xl-3 col-md-6">
                        <a href="#" data-section="simulaciones" class="text-decoration-none text-reset d-block h-100">
                            <div class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all d-flex flex-column"
                                style="border-radius: 20px;">
                                <div class="d-flex justify-content-between align-items-start mb-auto">
                                    <div class="rounded-circle bg-success bg-opacity-10 text-success p-3 d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="bi bi-calculator-fill fs-4"></i>
                                    </div>
                                    <i class="bi bi-arrow-up-right text-muted opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h5 class="fw-bold mb-2">Simuladores pro</h5>
                                    <p class="text-muted small mb-0 line-clamp-2">Proyecta tus ahorros, créditos e
                                        inversiones con alta precisión.</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Diagnóstico -->
                    <div class="col-xl-3 col-md-6">
                        <a href="{{ url_for('diagnostico') }}" class="text-decoration-none text-reset d-block h-100">
                            <div class="glass-card has-bubbles h-100 p-4 border border-danger border-opacity-10 shadow-sm hover-lift transition-all d-flex flex-column"
                                style="border-radius: 20px;">
                                <div class="d-flex justify-content-between align-items-start mb-auto">
                                    <div class="rounded-circle bg-danger bg-opacity-10 text-danger p-3 d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="bi bi-heart-pulse-fill fs-4"></i>
                                    </div>
                                    <i class="bi bi-arrow-up-right text-muted opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h5 class="fw-bold mb-2">Diagnóstico 360°</h5>
                                    <p class="text-muted small mb-0 line-clamp-2">Conoce tu salud financiera actual y
                                        recibe una estrategia personalizada.</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- SOFIPOs -->
                    <div class="col-xl-3 col-md-6">
                        <a href="/sofipos" class="text-decoration-none text-reset d-block h-100">
                            <div class="glass-card has-bubbles h-100 p-4 border border-warning border-opacity-25 shadow-sm hover-lift transition-all d-flex flex-column"
                                style="border-radius: 20px;">
                                <div class="d-flex justify-content-between align-items-start mb-auto">
                                    <div class="rounded-circle bg-warning bg-opacity-10 text-warning p-3 d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="bi bi-graph-up-arrow fs-4"></i>
                                    </div>
                                    <i class="bi bi-arrow-up-right text-muted opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h5 class="fw-bold mb-2">Ranking SOFIPOs</h5>
                                    <p class="text-muted small mb-0 line-clamp-2">Compara las tasas de rendimiento de
                                        las instituciones financieras populares.</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Glosario -->
                    <div class="col-xl-3 col-md-6">
                        <a href="#" data-section="glosario" class="text-decoration-none text-reset d-block h-100">
                            <div class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all d-flex flex-column"
                                style="border-radius: 20px;">
                                <div class="d-flex justify-content-between align-items-start mb-auto">
                                    <div class="rounded-circle bg-info bg-opacity-10 text-info p-3 d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 50px;">
                                        <i class="bi bi-book-half fs-4"></i>
                                    </div>
                                    <i class="bi bi-arrow-up-right text-muted opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h5 class="fw-bold mb-2">Diccionario A-Z</h5>
                                    <p class="text-muted small mb-0 line-clamp-2">Domina todos los conceptos clave
                                        explicados de forma sencilla.</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Desafío de conocimientos CTA -->
            <div class="mb-4">
                <a href="#" data-section="test-conocimientos"
                    class="text-decoration-none text-reset d-block hover-scale transition-all">
                    <div class="glass-card has-bubbles p-4 border-primary border-opacity-25 shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3"
                        style="border-radius: 20px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(13,110,253,0.05));">
                        <div class="d-flex align-items-center position-relative z-1">
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary p-3 d-flex align-items-center justify-content-center me-4"
                                style="width: 60px; height: 60px;">
                                <i class="bi bi-trophy-fill fs-3"></i>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-1 text-dark">Desafío de conocimientos</h4>
                                <p class="text-muted small mb-0">Demuestra tus habilidades financieras y evalúa lo
                                    aprendido.</p>
                            </div>
                        </div>
                        <div class="text-end position-relative z-1">
                            {% if session.get('test_completado') %}
                            <span
                                class="badge bg-success bg-opacity-10 text-success p-2 px-3 rounded-pill d-inline-flex align-items-center">
                                <i class="bi bi-check-circle-fill me-2"></i> Completado
                            </span>
                            {% else %}
                            <span class="btn btn-primary rounded-pill px-4" style="pointer-events: none;">
                                Iniciar test ahora <i class="bi bi-arrow-right ms-2"></i>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </a>
            </div>

        </div>
    </section>

    <!-- Sección: Simulaciones -->
    <!-- Sección: Simulaciones -->
    <section id="simulaciones-section" class="content-section d-none">
        <div class="fade-in">
            <div class="text-center mb-5">
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill mb-3 px-3 py-2">Herramientas
                    Pro</span>
                <h2 class="fw-bold mb-3 display-6">Centro de simulación</h2>
                <p class="lead text-muted mx-auto" style="max-width: 700px;">
                    Proyecta tu futuro con datos reales. Sin riesgos, toma el control de tus decisiones financieras hoy
                    mismo.
                </p>
            </div>

            <!-- Principales -->
            <div class="row g-4 mb-4">
                <!-- Ahorro -->
                <div class="col-lg-6">
                    <div
                        class="glass-card has-bubbles p-4 h-100 border-0 shadow-sm hover-scale transition-all d-flex align-items-center position-relative overflow-hidden">
                        <div class="row align-items-center w-100 g-0 position-relative z-1">
                            <div class="col-sm-3 text-center text-sm-start mb-3 mb-sm-0">
                                <div class="rounded-circle bg-success bg-opacity-10 p-4 d-inline-flex">
                                    <i class="bi bi-piggy-bank text-success fs-1"></i>
                                </div>
                            </div>
                            <div class="col-sm-9 ps-sm-3">
                                <h4 class="fw-bold mb-2">Simulador de ahorro</h4>
                                <p class="text-muted small mb-3">Define una meta (casa, auto, viaje) y calcula cuánto
                                    necesitas guardar mensualmente para lograrla.</p>
                                <a href="{{ url_for('simulador_ahorro') }}"
                                    class="btn btn-sm btn-outline-success rounded-pill stretched-link px-4">
                                    Comenzar ahora
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crédito -->
                <div class="col-lg-6">
                    <div
                        class="glass-card has-bubbles p-4 h-100 border-0 shadow-sm hover-scale transition-all d-flex align-items-center position-relative overflow-hidden">

                        <div class="row align-items-center w-100 g-0 position-relative z-1">
                            <div class="col-sm-3 text-center text-sm-start mb-3 mb-sm-0">
                                <div class="rounded-circle bg-primary bg-opacity-10 p-4 d-inline-flex">
                                    <i class="bi bi-bank text-primary fs-1"></i>
                                </div>
                            </div>
                            <div class="col-sm-9 ps-sm-3">
                                <h4 class="fw-bold mb-2">Simulador de crédito</h4>
                                <p class="text-muted small mb-3">Antes de pedir un préstamo, visualiza tu tabla de
                                    amortización, intereses y pago total real.</p>
                                <a href="{{ url_for('simulador_credito') }}"
                                    class="btn btn-sm btn-outline-primary rounded-pill stretched-link px-4">
                                    Simular préstamo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Herramientas Especializadas -->
            <h5 class="fw-bold text-muted mb-4 ps-3 border-start border-4 border-info mt-5">Herramientas especializadas
            </h5>
            <div class="row g-4">
                <!-- Inversión -->
                <div class="col-md-6 col-lg-3">
                    <div
                        class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all position-relative text-center text-lg-start">
                        <div class="rounded-circle bg-indigo bg-opacity-10 text-indigo p-3 d-inline-flex mb-3"
                            style="color: #6610f2; background-color: rgba(102, 16, 242, 0.1);">
                            <i class="bi bi-graph-up-arrow fs-4"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Inversión</h5>
                        <p class="text-muted small mb-3 line-clamp-2">Proyecta el interés compuesto de tu dinero en el
                            tiempo.</p>
                        <a href="{{ url_for('simulador_inversion') }}"
                            class="stretched-link text-decoration-none text-primary fw-bold small">
                            Proyectar <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Presupuesto -->
                <div class="col-md-6 col-lg-3">
                    <div
                        class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all position-relative text-center text-lg-start">
                        <div class="rounded-circle bg-info bg-opacity-10 text-info p-3 d-inline-flex mb-3">
                            <i class="bi bi-pie-chart fs-4"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Presupuesto</h5>
                        <p class="text-muted small mb-3 line-clamp-2">Distribuye tus ingresos y encuentra fugas de
                            dinero.</p>
                        <a href="{{ url_for('simulador_presupuesto_personal') }}"
                            class="stretched-link text-decoration-none text-primary fw-bold small">
                            Crear plan <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Retiro -->
                <div class="col-md-6 col-lg-3">
                    <div
                        class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all position-relative text-center text-lg-start">
                        <div class="rounded-circle bg-warning bg-opacity-10 text-warning p-3 d-inline-flex mb-3">
                            <i class="bi bi-umbrella fs-4"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Retiro</h5>
                        <p class="text-muted small mb-3 line-clamp-2">Calcula cuánto necesitas para tu libertad
                            financiera.</p>
                        <a href="{{ url_for('simulador_retiro_jubilacion') }}"
                            class="stretched-link text-decoration-none text-primary fw-bold small">
                            Planificar <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Deuda -->
                <div class="col-md-6 col-lg-3">
                    <div
                        class="glass-card has-bubbles h-100 p-4 border-0 shadow-sm hover-lift transition-all position-relative text-center text-lg-start">
                        <div class="rounded-circle bg-danger bg-opacity-10 text-danger p-3 d-inline-flex mb-3">
                            <i class="bi bi-calculator fs-4"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Deuda</h5>
                        <p class="text-muted small mb-3 line-clamp-2">Estrategias para salir de deudas más rápido.</p>
                        <a href="{{ url_for('calculadora_deuda') }}"
                            class="stretched-link text-decoration-none text-primary fw-bold small">
                            Calcular <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección: Test de conocimientos -->
    <section id="test-conocimientos-section" class="content-section d-none">
        <div class="glass-card has-bubbles p-4 fade-in">
            <div id="testHeader">
                <h2 class="mb-4 titulo-dashboard text-center">Test de conocimientos financieros</h2>
                <p class="lead text-muted text-center mb-5">Pon a prueba tus conocimientos financieros con nuestras
                    preguntas interactivas. ¡Aprende y diviértete!</p>
            </div>

            <!-- Pantalla de introducción al test -->
            <div id="testIntro" class="glass-panel p-0 overflow-hidden mb-4 border-0">
                <div class="row g-0">
                    <!-- Lateral decorativo / Hero -->
                    <div class="col-lg-5 bg-primary text-white p-5 d-flex flex-column justify-content-center align-items-center text-center position-relative overflow-hidden"
                        style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);">
                        <!-- Patrón de fondo -->
                        <div class="position-absolute"
                            style="top: -20px; left: -20px; font-size: 15rem; opacity: 0.1; transform: rotate(-15deg);">
                            <i class="bi bi-currency-exchange"></i>
                        </div>
                        <div class="position-absolute"
                            style="bottom: -50px; right: -50px; font-size: 12rem; opacity: 0.1; transform: rotate(15deg);">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>

                        <div class="position-relative z-1" style="animation: float 6s ease-in-out infinite;">
                            <div class="mb-4">
                                <span
                                    class="d-inline-flex align-items-center justify-content-center bg-white text-primary rounded-circle shadow-lg"
                                    style="width: 100px; height: 100px;">
                                    <i class="bi bi-trophy-fill fs-1"></i>
                                </span>
                            </div>
                            <h2 class="fw-bold mb-2">¡Desafíate a ti mismo!</h2>
                            <p class="mb-0 px-3 opacity-75 text-white" style="color: #fff !important;">Compite, aprende
                                y domina tus finanzas
                                personales.</p>
                        </div>
                    </div>

                    <!-- Contenido Informativo -->
                    <div class="col-lg-7 p-4 p-md-5 d-flex flex-column justify-content-center">
                        <div class="mb-2 text-uppercase fw-bold text-primary small tracking-wide">Test de conocimientos
                        </div>
                        <h3 class="mb-3 fw-bold display-6">¿Cuánto sabes realmente sobre dinero?</h3>
                        <p class="text-muted mb-4 lead" style="font-size: 1.1rem;">
                            Responde preguntas dinámicas sobre ahorro, inversión y crédito. Escala en el ranking y
                            demuestra que eres un experto.
                        </p>

                        <div class="row g-3 mb-4">
                            <div class="col-sm-4">
                                <div
                                    class="p-3 rounded-4 bg-soft-primary border border-light h-100 text-center hover-lift transition-all">
                                    <i class="bi bi-stopwatch fs-3 text-danger mb-2"></i>
                                    <h6 class="fw-bold mb-1">30s</h6>
                                    <p class="small text-muted mb-0">Por pregunta</p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div
                                    class="p-3 rounded-4 bg-soft-success border border-light h-100 text-center hover-lift transition-all">
                                    <i class="bi bi-star-fill fs-3 text-warning mb-2"></i>
                                    <h6 class="fw-bold mb-1">+ Puntos</h6>
                                    <p class="small text-muted mb-0">Por aciertos</p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div
                                    class="p-3 rounded-4 bg-soft-warning border border-light h-100 text-center hover-lift transition-all">
                                    <i class="bi bi-lightning-charge-fill fs-3 text-info mb-2"></i>
                                    <h6 class="fw-bold mb-1">Bonos</h6>
                                    <p class="small text-muted mb-0">Por velocidad</p>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-block text-center text-md-start">
                            <button id="startTestBtn"
                                class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg btn-shine">
                                Comenzar ahora <i class="bi bi-arrow-right-circle-fill ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor del test (visible si no se ha completado) -->
            <div id="testContainer" class="d-none">
                <!-- Header con Progreso y Timer -->
                <div class="d-flex justify-content-between align-items-center mb-2 gap-3">
                    <div class="d-flex align-items-center gap-3 flex-grow-1">
                        <div class="glass-panel px-3 py-2 d-flex align-items-center gap-2" style="border-radius: 50px;">
                            <span class="text-muted small fw-bold text-uppercase">Pregunta</span>
                            <span class="fw-bold text-primary"><span id="currentQuestionNum">1</span><span
                                    class="text-muted mx-1">/</span><span id="totalQuestionsNum">12</span></span>
                        </div>
                        <div class="progress flex-grow-1"
                            style="height: 8px; border-radius: 10px; background-color: rgba(0,0,0,0.1);">
                            <div class="progress-bar bg-primary position-relative overflow-visible" role="progressbar"
                                style="width: 0%; border-radius: 10px;">
                                <div class="position-absolute top-50 start-100 translate-middle bg-primary rounded-circle shadow"
                                    style="width: 12px; height: 12px; border: 2px solid white;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="timer-badge px-3 py-1 d-flex align-items-center gap-2">
                        <i class="bi bi-stopwatch text-primary fs-6"></i>
                        <span id="timerDisplayInternal" class="fw-bold fs-6 text-dark"><span
                                id="timeRemaining">30</span>s</span>
                    </div>
                    <!-- Elemento oculto para mantener compatibilidad con JS antiguo si es necesario -->
                    <div id="timerDisplay" class="d-none"></div>
                </div>

                <div class="question-card-premium mb-3">
                    <!-- Decoración fondo -->
                    <div class="bg-decoration-circle circle-1"></div>
                    <div class="bg-decoration-circle circle-2"></div>

                    <div class="row position-relative z-index-1">
                        <div class="col-12 text-center mb-2">
                            <h3 id="questionText" class="question-text-premium display-6">
                                <!-- La pregunta se renderiza aquí -->
                            </h3>
                        </div>
                        <div class="col-lg-10 mx-auto">
                            <div id="optionsContainer" class="d-flex flex-column gap-3">
                                <!-- Las opciones de respuesta se renderizarán aquí -->
                            </div>
                        </div>
                        <div class="col-12">
                            <div id="feedbackMessage" class="mt-4 text-center fs-5 fw-bold" style="min-height: 20px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center align-items-center mt-4 px-2">
                    <div>
                        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" id="checkAnswerBtn">
                            Comprobar <i class="bi bi-check-circle-fill ms-2"></i>
                        </button>
                        <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm d-none" id="nextQuestionBtn">
                            Siguiente <i class="bi bi-arrow-right-circle-fill ms-2"></i>
                        </button>
                        <button class="btn btn-success btn-lg rounded-pill px-5 shadow-sm d-none" id="submitTestBtn">
                            Finalizar test <i class="bi bi-send-fill ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sección de resultados inmediatos (después de terminar el test, antes de ver el ranking) -->
            <div id="testResult" class="glass-panel p-4 mt-5 d-none text-center">
                <h3 class="titulo-dashboard mb-3">Resultados del test</h3>
                <p class="fs-4">Respuestas correctas: <span id="scoreDisplay" class="fw-bold text-primary"></span> de
                    <span id="totalQuestionsDisplay" class="fw-bold"></span>
                </p>
                <p class="fs-4">Puntuación total: <span id="totalPointsDisplay" class="fw-bold text-success"></span></p>
                <p class="lead" id="resultMessage"></p>
                <button class="btn btn-info mt-3" id="viewRankingBtn">Ver ranking <i
                        class="bi bi-trophy ms-2"></i></button>
            </div>

            <!-- Sección para cuando el test ya ha sido completado (se carga al iniciar la sección del test) -->
            <div id="testCompletedSection" class="d-none animate-fade-in py-2">
                <div class="result-card-premium mx-auto p-4 p-md-5" style="max-width: 900px;">
                    <!-- Decoración de Fondo -->
                    <div
                        class="position-absolute top-0 start-0 translate-middle p-5 rounded-circle bg-success opacity-10 blur-xl">
                    </div>
                    <div
                        class="position-absolute bottom-0 end-0 translate-middle p-5 rounded-circle bg-primary opacity-10 blur-xl">
                    </div>

                    <div class="row align-items-center g-5 position-relative z-1">
                        <!-- Columna Izquierda: Título e Icono -->
                        <div class="col-md-5 text-center text-md-start">
                            <div
                                class="d-inline-flex p-3 rounded-circle bg-success bg-opacity-10 mb-3 animate-bounce-slow">
                                <i class="bi bi-trophy-fill text-success" style="font-size: 3.5rem;"></i>
                            </div>
                            <h2 class="fw-bold mb-2 text-gradient">¡Test completado!</h2>
                            <p class="text-muted mb-0">Has demostrado tus habilidades financieras con éxito.</p>
                        </div>

                        <!-- Columna Derecha: Estadísticas y Acción -->
                        <div class="col-md-7">
                            <div class="row g-3 mb-4">
                                <!-- Aciertos -->
                                <div class="col-6">
                                    <div
                                        class="p-3 rounded-4 h-100 text-center shadow-sm d-flex flex-column justify-content-center stats-card-premium">
                                        <div class="text-secondary small fw-bold text-uppercase mb-1 tracking-wide">
                                            Respuestas correctas</div>
                                        <div class="display-6 fw-bold mb-0">
                                            <span id="completedCorrectAnswers">0</span><span
                                                class="fs-4 text-muted opacity-75">/</span><span
                                                id="completedTotalQuestions" class="fs-4 text-muted opacity-75">0</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Puntos -->
                                <div class="col-6">
                                    <div
                                        class="p-3 rounded-4 h-100 text-center shadow-sm d-flex flex-column justify-content-center stats-card-premium">
                                        <div class="text-primary small fw-bold text-uppercase mb-1 tracking-wide">
                                            Puntuación total</div>
                                        <div class="display-6 fw-bold text-primary mb-0" id="completedTotalPoints">0
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center bg-primary bg-opacity-10 rounded-3 p-3 mb-4">
                                <p id="completedResultMessage" class="mb-0 fw-medium fst-italic text-primary"></p>
                            </div>

                            <button id="viewRankingBtnCompleted"
                                class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm transform-hover">
                                Ver ranking financiero <i class="bi bi-trophy-fill ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección: Glosario de términos -->
    <section id="glosario-section" class="content-section d-none">
        <div class="glass-card has-bubbles p-4 fade-in">
            <h2 class="mb-4 titulo-dashboard text-center">Glosario de términos financieros</h2>
            <p class="lead text-muted text-center mb-5">
                Explora y comprende los conceptos clave del mundo financiero. Desde términos básicos hasta definiciones
                más complejas, nuestro glosario está diseñado para ayudarte a dominar el lenguaje de las finanzas.
            </p>
            <div class="text-center">
                <a href="{{ url_for('glosario') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-book-fill me-2"></i> Ir al glosario completo
                </a>
            </div>
        </div>
    </section>

    <!-- Sección: Mi perfil -->
    <section id="perfil-section" class="content-section d-none">
        <div class="glass-card has-bubbles p-4 fade-in">
            <h2 class="mb-4 titulo-dashboard text-center">Mi perfil</h2>
            <p class="lead text-muted text-center mb-5">Aquí puedes revisar y gestionar tu información personal y los
                detalles de tu cuenta.</p>

            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="glass-card has-bubbles p-4 mb-4">
                        <h5 class="mb-3 text-primary"><i class="bi bi-person-circle me-2"></i> Información personal</h5>
                        <hr>
                        <div class="row mb-2">
                            <div class="col-md-4 text-muted">Nombre completo:</div>
                            <div class="col-md-8 fw-bold text-break">{{ session.get('nombres', '') }} {{
                                session.get('apellidos', '') }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 text-muted">Correo electrónico:</div>
                            <div class="col-md-8 fw-bold text-break">{{ session.get('correo', '') }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 text-muted">Fecha de registro:</div>
                            <div class="col-md-8 fw-bold">{{ session.get('fecha_registro', '') }}</div>
                        </div>
                        <!-- <div class="row mb-2">
                                <div class="col-md-4 text-muted">Tipo de cuenta:</div>
                                <div class="col-md-8 fw-bold">{{ usuario.tipo_cuenta }}</div>
                            </div> -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#editarPerfilModal">
                                <i class="bi bi-pencil-square me-2"></i> Editar información personal
                            </button>
                        </div>
                    </div>

                    <div class="glass-card has-bubbles p-4 mb-4">
                        <h5 class="mb-3 text-success"><i class="bi bi-shield-lock me-2"></i> Seguridad de la cuenta</h5>
                        <hr>
                        <div class="row mb-2">
                            <div class="col-md-4 text-muted">Último inicio de sesión:</div>
                            <div class="col-md-8 fw-bold">{{ session.get('ultima_sesion', '') }}</div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            {% if usuario.auth_method == 'google' %}
                            <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                                <i class="bi bi-google me-2"></i>
                                <div>
                                    Iniciaste sesión con Google Account
                                </div>
                            </div>
                            {% else %}
                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#cambiarContrasenaModal">
                                <i class="bi bi-key me-2"></i> Cambiar contraseña
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block extra_modals %}
<!-- Modal: Editar información personal -->
<div class="modal fade" id="editarPerfilModal" tabindex="-1" aria-labelledby="editarPerfilModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="editarPerfilModalLabel">Editar información personal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form action="/actualizar_perfil" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editNombres" class="form-label">Nombre(s):</label>
                        <input type="text" class="form-control glass-input" id="editNombres" name="nombres"
                            value="{{ session.get('nombres', '') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editApellidos" class="form-label">Apellidos:</label>
                        <input type="text" class="form-control glass-input" id="editApellidos" name="apellidos"
                            value="{{ session.get('apellidos', '') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCorreo" class="form-label">Correo electrónico:</label>
                        <input type="email" class="form-control glass-input" id="editCorreo" name="correo_electronico"
                            value="{{ session.get('correo', '') }}" readonly>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Cambiar contraseña -->
<div class="modal fade" id="cambiarContrasenaModal" tabindex="-1" aria-labelledby="cambiarContrasenaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="cambiarContrasenaModalLabel">Cambiar contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formCambiarContrasena" action="/cambiar_contrasena" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="contrasenaActual" class="form-label">Contraseña actual:</label>
                        <div class="input-group">
                            <input type="password" class="form-control glass-input" id="contrasenaActual"
                                name="contrasena_actual" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button"
                                data-target="contrasenaActual">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="nuevaContrasena" class="form-label">Nueva contraseña:</label>
                        <div class="input-group">
                            <input type="password" class="form-control glass-input" id="nuevaContrasena"
                                name="nueva_contrasena" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button"
                                data-target="nuevaContrasena">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div id="nuevaContrasenaFeedback" class="invalid-feedback d-block"></div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmarNuevaContrasena" class="form-label">Confirmar nueva contraseña:</label>
                        <div class="input-group">
                            <input type="password" class="form-control glass-input" id="confirmarNuevaContrasena"
                                name="confirmar_nueva_contrasena" required>
                            <button class="btn btn-outline-secondary toggle-password" type="button"
                                data-target="confirmarNuevaContrasena">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div id="confirmarNuevaContrasenaFeedback" class="invalid-feedback d-block"></div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitCambiarContrasena">Cambiar
                        contraseña</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Resultados del test (se mantiene, pero su contenido será dinámico) -->
<!-- Modal: Resultados del test -->
<div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-premium-content border-0">
            <div class="modal-header border-0 flex-column align-items-center justify-content-center pt-4 pb-0">
                <div class="mb-3 p-3 rounded-circle bg-success bg-opacity-10 text-success">
                    <i class="bi bi-trophy-fill fs-2"></i>
                </div>
                <h4 class="modal-title fw-bold" id="testResultModalLabel">Resultados del Test</h4>
            </div>
            <div class="modal-body text-center py-3 px-4">
                <p class="fs-5 mb-3">Has respondido <span id="finalScoreModal" class="fw-bold text-primary"></span> de
                    <span id="totalQuestionsModal" class="fw-bold"></span> preguntas correctamente.
                </p>

                <div class="p-3 my-3 rounded-3" style="background: rgba(var(--bs-primary-rgb), 0.05);">
                    <p class="fs-4 mb-0">Puntuación Total: <span id="finalTotalPointsModal"
                            class="fw-bold text-success display-6 d-block mt-2"></span></p>
                </div>

                <p class="lead fst-italic mt-3" id="resultMessageModal"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center gap-3 pb-4">
                <button type="button" class="btn btn-primary rounded-pill px-4 shadow-sm"
                    data-bs-dismiss="modal">Aceptar</button>
                <button type="button" class="btn btn-outline-info rounded-pill px-4 shadow-sm"
                    id="viewRankingBtnModal">Ver Ranking <i class="bi bi-trophy ms-2"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ranking -->
<div class="modal fade" id="rankingModal" tabindex="-1" aria-labelledby="rankingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-premium-content border-0">
            <div class="modal-header border-0 align-items-center justify-content-between pt-4 px-4 pb-2">
                <h4 class="modal-title fw-bold mb-0" id="rankingModalLabel">Ranking financiero</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body px-4">
                <!-- Removed overflow-hidden to allow table-responsive to work -->
                <div class="table-responsive rounded-3 border custom-ranking-scroll">
                    <table class="table table-hover table-premium mb-0 align-middle text-nowrap">
                        <thead>
                            <tr>
                                <th scope="col" class="py-3 ps-3">Pos.</th>
                                <th scope="col" class="py-3">Usuario</th>
                                <th scope="col" class="py-3">Puntos</th>
                                <th scope="col" class="py-3">Tiempo</th>
                                <th scope="col" class="py-3 pe-3 text-center">Aciertos</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTableBody">
                            <!-- Filas del ranking se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
                <div id="userRankingInfo"
                    class="mt-4 p-3 rounded-3 glass-panel d-none border border-primary border-opacity-25 bg-primary bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="mb-0 fw-bold text-primary">Tu posición: #<span id="userPositionDisplay"></span></h6>
                        <div class="d-flex gap-3 text-muted small">
                            <span>Puntos: <strong id="userScoreRanking" class="text-dark"></strong></span>
                            <span>Tiempo: <strong id="userTimeRanking" class="text-dark"></strong>s</span>
                            <span>Acier.: <strong id="userCorrectRanking" class="text-dark"></strong></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<style>
    /* Mobile optimization for Ranking Table */
    @media (max-width: 576px) {
        #rankingModal .table-premium thead th {
            font-size: 0.85rem;
            padding: 0.5rem 0.25rem;
        }

        #rankingModal .table-premium tbody td {
            font-size: 0.85rem;
            padding: 0.5rem 0.25rem;
        }

        #rankingModal .modal-body {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        /* Make the user name truncated if too long on very small screens */
        #rankingTableBody td:nth-child(2) {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="js/dashboard.js"></script>
{% endblock %}